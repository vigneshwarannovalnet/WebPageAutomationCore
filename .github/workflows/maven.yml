  send_email:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download test results artifact
        uses: actions/download-artifact@v3
        with:
          name: test-results
          path: ./test-results

      - name: Verify test-results.zip exists
        run: |
          echo "Checking if test-results.zip exists in the expected directory..."
          ls -lh ./test-results/
          if [ ! -f "./test-results/test-results.zip" ]; then
            echo "Error: test-results.zip file not found!"
            exit 1
          fi
          echo "test-results.zip is present and ready for email attachment."

      - name: Debug SendGrid API Key
        run: |
          if [ -z "${{ secrets.SENDGRID_API_KEY }}" ]; then
            echo "Error: SENDGRID_API_KEY is not set in GitHub Secrets."
            exit 1
          else
            echo "SENDGRID_API_KEY is set."
          fi

      - name: Send Email with Test Results
        run: |
          echo "Preparing to send email with SendGrid..."
          ZIP_FILE_CONTENT=$(base64 -w 0 ./test-results/test-results.zip)
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST https://api.sendgrid.com/v3/mail/send \
            -H "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "personalizations": [
                    {
                      "to": [{"email": "mohamedn_m@novalnetsolutions.com"}],
                      "subject": "GitHub Actions Test Results"
                    }
                  ],
                  "from": {"email": "noreply@example.com"},
                  "content": [
                    {
                      "type": "text/plain",
                      "value": "The test results are available. Please check the attached zip file.\n\nTest Results: test-results.zip"
                    }
                  ],
                  "attachments": [
                    {
                      "content": "'"${ZIP_FILE_CONTENT}"'",
                      "filename": "test-results.zip",
                      "type": "application/zip",
                      "disposition": "attachment"
                    }
                  ]
                }')
          echo "SendGrid API response code: $RESPONSE"
          echo "SendGrid API response body:"
          cat response.txt

          if [ "$RESPONSE" -ne 202 ]; then
            echo "Error: Failed to send email. Response code $RESPONSE"
            exit 1
          else
            echo "Email successfully sent via SendGrid."
          fi
